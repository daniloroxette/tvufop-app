name: Update HLS (1080p only) when manifest_url.txt changes

on:
  push:
    branches: [ "main" ]
    paths:
      - "manifest_url.txt"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read manifest URL
        id: m
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f manifest_url.txt ]; then
            echo "manifest_url.txt não encontrado."
            exit 1
          fi
          MANIFEST_URL="$(cat manifest_url.txt | tr -d '\r' | head -n 1 | xargs)"
          if [ -z "$MANIFEST_URL" ]; then
            echo "manifest_url.txt está vazio."
            exit 1
          fi
          echo "manifest_url=$MANIFEST_URL" >> "$GITHUB_OUTPUT"

      - name: Generate expanded m3u8 (1080p only | no-cache + cache-buster + normalize llhlsHBs)
        shell: bash
        run: |
          python3 - <<'PY'
          import os, re, time, urllib.parse, urllib.request

          manifest_url = "${{ steps.m.outputs.manifest_url }}".strip()

          if not manifest_url.startswith("http"):
            raise SystemExit("manifest_url inválida (não parece URL).")
          if "/manifest/" not in manifest_url:
            raise SystemExit("A URL precisa conter /manifest/ (ex.: .../manifest/video.m3u8).")

          # Base: https://.../<VIDEO_ID>/manifest/
          base = manifest_url.split("/manifest/", 1)[0] + "/manifest/"

          # Cache-buster + headers no-cache (reduz variação por cache)
          p = urllib.parse.urlsplit(manifest_url)
          qs2 = (p.query + "&" if p.query else "") + f"_cb={int(time.time())}"
          fetch_url = urllib.parse.urlunsplit((p.scheme, p.netloc, p.path, qs2, p.fragment))

          req = urllib.request.Request(
            fetch_url,
            headers={
              "Cache-Control": "no-cache",
              "Pragma": "no-cache",
              "User-Agent": "Mozilla/5.0"
            }
          )

          with urllib.request.urlopen(req) as r:
            raw = r.read().decode("utf-8", errors="replace")

          # Normaliza llhlsHBs sempre para 0.9
          hb_re  = re.compile(r'(llhlsHBs=)[0-9.]+')
          uri_re = re.compile(r'URI="([^"]+)"')

          def norm_hb(s: str) -> str:
            return hb_re.sub(r"\g<1>0.9", s)

          def absolutize(u: str) -> str:
            u = norm_hb(u)
            return u if u.startswith("http") else (base + u)

          lines = [l.rstrip("\r\n") for l in raw.splitlines()]

          out = []
          want_1080 = False
          found_1080 = False

          # 1) Copia cabeçalhos essenciais (se existirem no arquivo fonte)
          # (mantém compatibilidade com o que a origem fornece)
          for l in lines:
            if l.startswith("#EXTM3U"):
              out.append("#EXTM3U")
              break
          else:
            out.append("#EXTM3U")

          # Inclui VERSION / INDEPENDENT-SEGMENTS se existirem
          for tag in ("#EXT-X-VERSION", "#EXT-X-INDEPENDENT-SEGMENTS"):
            for l in lines:
              if l.startswith(tag):
                out.append(norm_hb(l))
                break

          # 2) Copia todas as linhas #EXT-X-MEDIA (áudio), com URI absolutizada
          for l in lines:
            if l.startswith("#EXT-X-MEDIA:"):
              l2 = norm_hb(l)

              def repl(m):
                u = m.group(1)
                return f'URI="{absolutize(u)}"'
              l2 = uri_re.sub(repl, l2)

              out.append(l2)

          # 3) Seleciona apenas o variant 1920x1080 e sua URI subsequente
          i = 0
          while i < len(lines):
            l = lines[i]

            if l.startswith("#EXT-X-STREAM-INF:"):
              l2 = norm_hb(l)

              # Confere RESOLUTION=1920x1080
              # (evita depender da ordem de atributos)
              if "RESOLUTION=1920x1080" in l2:
                out.append(l2)
                # Próxima linha deve ser a URI do playlist do variant
                j = i + 1
                while j < len(lines) and (lines[j].strip() == "" or lines[j].startswith("#")):
                  j += 1
                if j >= len(lines):
                  raise SystemExit("Encontrou STREAM-INF 1080p, mas não encontrou a URI do variant logo em seguida.")
                out.append(absolutize(lines[j].strip()))
                found_1080 = True
                break

            i += 1

          if not found_1080:
            raise SystemExit("Não encontrei variant 1920x1080 no manifest. A Action foi interrompida para evitar publicar m3u8 inválido.")

          # 4) Grava no caminho usado pelos apps
          os.makedirs("hls", exist_ok=True)
          with open("hls/tvufop.m3u8", "w", encoding="utf-8", newline="\n") as f:
            f.write("\n".join(out) + "\n")

          print("OK: hls/tvufop.m3u8 (1080p only) atualizado a partir de:", manifest_url)
          PY

      - name: Commit and push if changed
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "Sem mudanças no hls/tvufop.m3u8."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add hls/tvufop.m3u8
          git commit -m "Update HLS (1080p only) from manifest_url.txt"
          git push
