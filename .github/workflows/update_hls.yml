name: Update HLS when manifest_url.txt changes

on:
  push:
    branches: [ "main" ]
    paths:
      - "manifest_url.txt"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read manifest URL
        id: m
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f manifest_url.txt ]; then
            echo "manifest_url.txt não encontrado."
            exit 1
          fi
          MANIFEST_URL="$(cat manifest_url.txt | tr -d '\r' | head -n 1 | xargs)"
          if [ -z "$MANIFEST_URL" ]; then
            echo "manifest_url.txt está vazio."
            exit 1
          fi
          echo "manifest_url=$MANIFEST_URL" >> "$GITHUB_OUTPUT"

      - name: Generate expanded m3u8 (no-cache + cache-buster + normalize llhlsHBs)
        shell: bash
        run: |
          python3 - <<'PY'
          import os, re, time, urllib.parse, urllib.request

          manifest_url = "${{ steps.m.outputs.manifest_url }}".strip()

          if not manifest_url.startswith("http"):
            raise SystemExit("manifest_url inválida (não parece URL).")
          if "/manifest/" not in manifest_url:
            raise SystemExit("A URL precisa conter /manifest/ (ex.: .../manifest/video.m3u8).")

          base = manifest_url.split("/manifest/", 1)[0] + "/manifest/"

          # Cache-buster + headers no-cache (reduz variação por cache)
          p = urllib.parse.urlsplit(manifest_url)
          qs2 = (p.query + "&" if p.query else "") + f"_cb={int(time.time())}"
          fetch_url = urllib.parse.urlunsplit((p.scheme, p.netloc, p.path, qs2, p.fragment))

          req = urllib.request.Request(
            fetch_url,
            headers={
              "Cache-Control": "no-cache",
              "Pragma": "no-cache",
              "User-Agent": "Mozilla/5.0"
            }
          )

          with urllib.request.urlopen(req) as r:
            raw = r.read().decode("utf-8", errors="replace")

          uri_re = re.compile(r'URI="([^"]+)"')
          hb_re  = re.compile(r'(llhlsHBs=)[0-9.]+')

          out = []

          for line in raw.splitlines():
            line = line.rstrip("\r\n")

            # Normaliza llhlsHBs para 0.9 (evita 0.5/0.9 alternando)
            line = hb_re.sub(r"\g<1>0.9", line)

            # Ajusta URI="..." dentro de tags (#EXT-X-MEDIA etc.)
            def repl(m):
              u = m.group(1)
              u = hb_re.sub(r"\g<1>0.9", u)
              return f'URI="{u}"' if u.startswith("http") else f'URI="{base}{u}"'
            line = uri_re.sub(repl, line)

            if line.startswith("#") or line.strip() == "":
              out.append(line)
            else:
              # Linha de playlist relativa vira absoluta
              if not line.startswith("http"):
                line = base + line
              out.append(line)

          os.makedirs("hls", exist_ok=True)
          with open("hls/tvufop.m3u8", "w", encoding="utf-8", newline="\n") as f:
            f.write("\n".join(out) + "\n")

          print("OK: hls/tvufop.m3u8 atualizado a partir de:", manifest_url)
          PY

      - name: Commit and push if changed
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "Sem mudanças no hls/tvufop.m3u8."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add hls/tvufop.m3u8
          git commit -m "Update HLS from manifest_url.txt"
          git push
