name: Update HLS (prefer 1080p) when manifest_url.txt changes

on:
  push:
    branches: [ "main" ]
    paths:
      - "manifest_url.txt"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Read manifest URL
        id: m
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f manifest_url.txt ]; then
            echo "manifest_url.txt não encontrado."
            exit 1
          fi
          MANIFEST_URL="$(cat manifest_url.txt | tr -d '\r' | head -n 1 | xargs)"
          if [ -z "$MANIFEST_URL" ]; then
            echo "manifest_url.txt está vazio."
            exit 1
          fi
          echo "manifest_url=$MANIFEST_URL" >> "$GITHUB_OUTPUT"
          echo "Manifest URL: $MANIFEST_URL"

      - name: Generate expanded m3u8 (single-variant | prefer 1080p | no-cache + cache-buster + normalize llhlsHBs)
        shell: bash
        run: |
          python3 - <<'PY'
          import os, re, time, urllib.parse, urllib.request

          manifest_url = "${{ steps.m.outputs.manifest_url }}".strip()

          if not manifest_url.startswith("http"):
            raise SystemExit("manifest_url inválida (não parece URL).")
          if "/manifest/" not in manifest_url:
            raise SystemExit("A URL precisa conter /manifest/ (ex.: .../manifest/video.m3u8).")

          base = manifest_url.split("/manifest/", 1)[0] + "/manifest/"

          # Cache-buster + headers no-cache
          p = urllib.parse.urlsplit(manifest_url)
          qs2 = (p.query + "&" if p.query else "") + f"_cb={int(time.time())}"
          fetch_url = urllib.parse.urlunsplit((p.scheme, p.netloc, p.path, qs2, p.fragment))

          req = urllib.request.Request(
            fetch_url,
            headers={
              "Accept": "application/vnd.apple.mpegurl, application/x-mpegURL, text/plain, */*",
              "Cache-Control": "no-cache",
              "Pragma": "no-cache",
              "User-Agent": "Mozilla/5.0"
            }
          )

          try:
            with urllib.request.urlopen(req, timeout=20) as r:
              raw = r.read().decode("utf-8", errors="replace")
          except Exception as e:
            raise SystemExit(f"Falha ao baixar manifest: {manifest_url}\nErro: {e}")

          lines = [l.rstrip("\r\n") for l in raw.splitlines()]

          hb_re  = re.compile(r'(llhlsHBs=)[0-9.]+')
          uri_re = re.compile(r'URI="([^"]+)"')
          res_re = re.compile(r'RESOLUTION=(\d+)x(\d+)')
          bw_re  = re.compile(r'BANDWIDTH=(\d+)')
